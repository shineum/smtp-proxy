# =============================================================================
# Docker Compose - smtp-proxy local development stack
#
# Quick start:
#   docker compose up -d --build            # Start everything (zero prerequisites)
#   docker compose run --rm test-client     # Send test email (zero flags)
#   docker compose down                     # Stop all services
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL 17
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:18-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-smtp_proxy}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-smtp_proxy_dev}
      POSTGRES_DB: ${POSTGRES_DB:-smtp_proxy}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-smtp_proxy}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # Redis 7.4
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7.4-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # Database migrations (runs once and exits)
  # ---------------------------------------------------------------------------
  migrate:
    image: migrate/migrate:v4.18.1
    command:
      - "-path=/migrations"
      - "-database"
      - "${SMTP_PROXY_DATABASE_URL:-postgres://smtp_proxy:smtp_proxy_dev@postgres:5432/smtp_proxy?sslmode=disable}"
      - "up"
    volumes:
      - ./server/migrations:/migrations:ro
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # SMTP Server
  # ---------------------------------------------------------------------------
  smtp-server:
    build:
      context: ./server
      dockerfile: Dockerfile
      target: smtp-server
    ports:
      - "587:587"
      - "465:465"
    environment:
      SMTP_PROXY_DATABASE_URL: ${SMTP_PROXY_DATABASE_URL:-postgres://smtp_proxy:smtp_proxy_dev@postgres:5432/smtp_proxy?sslmode=disable}
      SMTP_PROXY_QUEUE_REDIS_ADDR: ${SMTP_PROXY_QUEUE_REDIS_ADDR:-redis:6379}
      SMTP_PROXY_DELIVERY_MODE: ${SMTP_PROXY_DELIVERY_MODE:-sync}
      SMTP_PROXY_AUTH_SIGNING_KEY: ${SMTP_PROXY_AUTH_SIGNING_KEY:-dev-signing-key-change-in-production}
      SMTP_PROXY_LOGGING_LEVEL: ${SMTP_PROXY_LOGGING_LEVEL:-debug}
      # SMTP_PROXY_TLS_MODE: "none"  # Uncomment to disable TLS (when terminated by NLB/proxy)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # API Server
  # ---------------------------------------------------------------------------
  api-server:
    build:
      context: ./server
      dockerfile: Dockerfile
      target: api-server
    ports:
      - "8080:8080"
    environment:
      SMTP_PROXY_DATABASE_URL: ${SMTP_PROXY_DATABASE_URL:-postgres://smtp_proxy:smtp_proxy_dev@postgres:5432/smtp_proxy?sslmode=disable}
      SMTP_PROXY_QUEUE_REDIS_ADDR: ${SMTP_PROXY_QUEUE_REDIS_ADDR:-redis:6379}
      SMTP_PROXY_DELIVERY_MODE: ${SMTP_PROXY_DELIVERY_MODE:-sync}
      SMTP_PROXY_AUTH_SIGNING_KEY: ${SMTP_PROXY_AUTH_SIGNING_KEY:-dev-signing-key-change-in-production}
      SMTP_PROXY_LOGGING_LEVEL: ${SMTP_PROXY_LOGGING_LEVEL:-debug}
      SMTP_PROXY_ADMIN_EMAIL: ${SMTP_PROXY_ADMIN_EMAIL:-admin@localhost}
      SMTP_PROXY_ADMIN_PASSWORD: ${SMTP_PROXY_ADMIN_PASSWORD:-admin}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # Dev seed (runs once and exits)
  # System admin is auto-seeded by the API server on startup.
  # This service creates a dev company group and SMTP account for testing.
  # ---------------------------------------------------------------------------
  seed:
    image: curlimages/curl:8.11.1
    entrypoint: ["sh", "-c"]
    command:
      - |
        # Wait for API server to be ready
        echo "Waiting for API server..."
        until curl -sf http://api-server:8080/healthz > /dev/null 2>&1; do sleep 1; done

        # Login as system admin to get JWT token
        TOKEN=$$(curl -sf -X POST http://api-server:8080/api/v1/auth/login \
          -H 'Content-Type: application/json' \
          -d '{"email":"admin@localhost","password":"admin"}' | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)

        if [ -z "$$TOKEN" ]; then
          echo "ERROR: Failed to get admin token"
          exit 1
        fi

        # Create dev company group
        GROUP_ID=$$(curl -sf -X POST http://api-server:8080/api/v1/groups \
          -H "Authorization: Bearer $$TOKEN" \
          -H 'Content-Type: application/json' \
          -d '{"name":"dev-company","monthly_limit":1000}' | grep -o '"id":"[^"]*"' | cut -d'"' -f4)

        if [ -z "$$GROUP_ID" ]; then
          echo "Dev company group may already exist"
        else
          echo "Dev company group created: $$GROUP_ID"
        fi

        # Create SMTP account in the dev company
        SMTP_RESULT=$$(curl -sf -X POST http://api-server:8080/api/v1/users \
          -H "Authorization: Bearer $$TOKEN" \
          -H 'Content-Type: application/json' \
          -d "{\"email\":\"dev@smtp.internal\",\"account_type\":\"smtp\",\"username\":\"dev\",\"group_id\":\"$$GROUP_ID\",\"allowed_domains\":[\"example.com\"]}")

        API_KEY=$$(echo "$$SMTP_RESULT" | grep -o '"api_key":"[^"]*"' | cut -d'"' -f4)

        if [ -n "$$API_KEY" ]; then
          echo "SMTP account created: dev (api_key=$$API_KEY)"
        else
          echo "SMTP account may already exist"
        fi

        echo "Seed complete"
    depends_on:
      api-server:
        condition: service_healthy
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # Queue Worker
  # ---------------------------------------------------------------------------
  queue-worker:
    build:
      context: ./server
      dockerfile: Dockerfile
      target: queue-worker
    environment:
      SMTP_PROXY_DATABASE_URL: ${SMTP_PROXY_DATABASE_URL:-postgres://smtp_proxy:smtp_proxy_dev@postgres:5432/smtp_proxy?sslmode=disable}
      SMTP_PROXY_QUEUE_REDIS_ADDR: ${SMTP_PROXY_QUEUE_REDIS_ADDR:-redis:6379}
      SMTP_PROXY_DELIVERY_MODE: ${SMTP_PROXY_DELIVERY_MODE:-sync}
      SMTP_PROXY_AUTH_SIGNING_KEY: ${SMTP_PROXY_AUTH_SIGNING_KEY:-dev-signing-key-change-in-production}
      SMTP_PROXY_LOGGING_LEVEL: ${SMTP_PROXY_LOGGING_LEVEL:-debug}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    networks:
      - backend

  # ---------------------------------------------------------------------------
  # Test Client (on-demand: docker compose run --rm test-client)
  # ---------------------------------------------------------------------------
  test-client:
    build:
      context: ./server
      dockerfile: Dockerfile
      target: test-client
    command:
      - "--host=smtp-server"
      - "--port=587"
      - "--tls=starttls"
      - "--insecure"
      - "--user=dev"
      - "--password=dev"
      - "--from=dev@example.com"
      - "--to=recipient@example.com"
      - "--subject=Test Email"
      - "--body=Hello from smtp-proxy test client."
      # Uncomment to test attachments:
      # - "--attach=/test-data/sample.txt"
      # - "--attach=/test-data/sample.html"
    volumes:
      - ./test-data:/test-data:ro
    profiles:
      - tools
    networks:
      - backend

volumes:
  postgres-data:
  redis-data:

networks:
  backend:
    driver: bridge
